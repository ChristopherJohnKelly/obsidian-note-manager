version: '3.8'

services:
  librarian-runner:
    build:
      context: .
      args:
        # Change to 'x64' if running on non-Apple Silicon Mac
        RUNNER_ARCH: arm64 
    image: obs-librarian-runner
    environment:
      # Pass these in a .env file
      REPO_URL: "https://github.com/christopherjohnkelly/obsidian-notes"
      GITHUB_PAT: "${GITHUB_PAT}"
      GITHUB_TOKEN: "${GITHUB_RUNNER_TOKEN}"  # Legacy: kept for backward compatibility
      RUNNER_NAME: "pi-librarian"
      GEMINI_API_KEY: "${GEMINI_API_KEY}"
      OBSIDIAN_AREAS_FOLDER: "${OBSIDIAN_AREAS_FOLDER}"
      OBSIDIAN_PROJECTS_FOLDER: "${OBSIDIAN_PROJECTS_FOLDER}"
      OBSIDIAN_RESOURCES_FOLDER: "${OBSIDIAN_RESOURCES_FOLDER}"
      OBSIDIAN_SYSTEM_DIR: "${OBSIDIAN_SYSTEM_DIR}"
      OBSIDIAN_CAPTURE_DIR: "${OBSIDIAN_CAPTURE_DIR}"
      OBSIDIAN_REVIEW_DIR: "${OBSIDIAN_REVIEW_DIR}"
      OBSIDIAN_SYSTEM_INSTRUCTIONS: "${OBSIDIAN_SYSTEM_INSTRUCTIONS}"
      OBSIDIAN_TAG_GLOSSARY: "${OBSIDIAN_TAG_GLOSSARY}"
      OBSIDIAN_LOG_DIR: "${OBSIDIAN_LOG_DIR}"
      OBSIDIAN_HISTORY_FILE: "${OBSIDIAN_HISTORY_FILE}"
    # Uncomment the following volume mount for development (allows code changes without rebuild)
    # volumes:
    #   - ./src:/home/runner/src
    restart: unless-stopped
    volumes:
      # Note: .runner config persistence removed due to permission issues
      # With PAT-based token fetching, re-registration is automatic and painless
      # If persistence needed later, use a file copy approach instead of direct mount
      - ./test_note.md:/home/runner/test_note.md
